<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador en Línea</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="./resources/ol.css">
    <link rel="stylesheet" href="resources/fontawesome-all.min.css">
    <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
    <link rel="stylesheet" href="./resources/qgis2web.css">
    <style>
        html, body {
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            height: 100%;
        }
        .ol-control > * {
            background-color: #f8f8f8!important;
            color: #444444!important;
            border-radius: 0px;
        }
        .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
            color: #444444!important;
        }
        .search-layer-input-search {
            background-color: #f8f8f8!important;
        }
        .ol-control > *:focus, .ol-control >*:hover {
            background-color: rgba(248, 248, 248, 0.7)!important;
        } 
        .ol-control {
            background-color: rgba(255,255,255,.4) !important;
            padding: 2px !important;
        }
        #coordinates {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <header>
        <h1>Bienvenido al Visualizador en Línea</h1>
        <input type="text" id="searchBar" placeholder="Buscar por CLAVE1K">
        <button onclick="buscarElemento()">Buscar</button>
    </header>

    <div id="map"></div>

    <footer>
        <p>&copy; 2025 Inygeo. Todos los derechos reservados.</p>
    </footer>

    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>

    <div id="coordinates">Coordenadas: -</div>

    <script src="resources/qgis2web_expressions.js"></script>
    <script src="./resources/functions.js"></script>
    <script src="./resources/ol.js"></script>
    <script src="./resources/ol-layerswitcher.js"></script>
    <script src="layers/MALLA_TIJUANA_CARTAS1K_1.js"></script>
    <script src="layers/PROCESADAS_2.js"></script>
    <script src="layers/VOLADAS_3.js"></script>
    <script src="layers/ENTREGADAS_4.js"></script>
    <script src="styles/MALLA_TIJUANA_CARTAS1K_1_style.js"></script>
    <script src="styles/PROCESADAS_2_style.js"></script>
    <script src="styles/VOLADAS_3_style.js"></script>
    <script src="styles/ENTREGADAS_4_style.js"></script>
    <script src="./layers/layers.js" type="text/javascript"></script> 
    <script src="./resources/Autolinker.min.js"></script>
    <script src="./resources/qgis2web.js"></script>

    <script>
        // Inicializa el mapa de OpenLayers
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([-106.4509, 32.5027]), // Coordenadas de ejemplo
                zoom: 12
            })
        });

        // Estilo de resaltado
        var highlightStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'yellow', // Color del borde resaltado
                width: 3
            }),
            fill: new ol.style.Fill({
                color: 'rgba(255, 255, 0, 0.3)' // Color de relleno semi-transparente
            })
        });

        var selectedFeature = null;

        // Evento para detectar movimiento del cursor sobre el mapa
        map.on('pointermove', function (event) {
            let featureFound = false;
            
            map.getTargetElement().style.cursor = '';

            map.forEachFeatureAtPixel(event.pixel, function (feature, layer) {
                if (layer) {
                    featureFound = true;
                    if (selectedFeature !== feature) {
                        if (selectedFeature) {
                            selectedFeature.setStyle(null); // Restaurar estilo del anterior
                        }
                        selectedFeature = feature;
                        selectedFeature.setStyle(highlightStyle);
                        map.getTargetElement().style.cursor = 'pointer';
                    }
                }
            });

            // Si no se encontró ningún feature, quitar el resaltado del anterior
            if (!featureFound && selectedFeature) {
                selectedFeature.setStyle(null);
                selectedFeature = null;
            }

            // Obtener las coordenadas del cursor y mostrar
            var coordinate = event.coordinate;
            var transformedCoord = ol.proj.toLonLat(coordinate); // Transformar a longitud/latitud
            var coordsString = 'Lon: ' + transformedCoord[0].toFixed(6) + ' | Lat: ' + transformedCoord[1].toFixed(6);
            document.getElementById('coordinates').innerHTML = 'Coordenadas: ' + coordsString;
        });

        // Evento para limpiar cuando el cursor sale del mapa
        map.getViewport().addEventListener('mouseleave', function () {
            if (selectedFeature) {
                selectedFeature.setStyle(null);
                selectedFeature = null;
            }
        });

        // Cargar la capa MALLA_TIJUANA_CARTAS1K_1.js desde layers
        var capaMalla;
        fetch('layers/MALLA_TIJUANA_CARTAS1K_1.js')
            .then(response => response.json())
            .then(data => {
                capaMalla = L.geoJSON(data, {
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup("CLAVE1K: " + feature.properties.CLAVE1K);
                    }
                }).addTo(mapa);
            });

        function buscarElemento() {
            var claveBuscada = document.getElementById("searchBar").value;

            if (!claveBuscada) {
                alert("Por favor, ingrese una clave CLAVE1K para buscar.");
                return;
            }

            if (!capaMalla) {
                alert("Capa de malla no cargada.");
                return;
            }

            capaMalla.eachLayer(function (layer) {
                if (layer.feature.properties.CLAVE1K == claveBuscada) {
                    var coordenadas = layer.getBounds().getCenter();
                    mapa.setView(coordenadas, 15);  // Zoom al elemento encontrado
                    layer.openPopup();  // Muestra el popup con la información
                }
            });
        }
    </script>
</body>
</html>
